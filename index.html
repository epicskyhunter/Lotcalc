<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plum Lot Allocator & Billing</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Noto+Serif:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Noto Serif', serif; }
        
        @media print {
            @page { 
                margin: 0.5cm; 
                size: auto; 
            }
            body { -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            table, th, td { border-color: #9ca3af !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- ================= MAIN APP (SCREEN VIEW) ================= -->
    <div id="app" class="p-4 md:p-8 max-w-5xl mx-auto no-print">
        
        <!-- Header -->
        <div class="flex items-center gap-3 mb-8">
            <div class="bg-indigo-600 p-3 rounded-xl text-white shadow-lg shadow-indigo-200">
                <i data-lucide="box" class="w-8 h-8"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-slate-900">Plum Lot Allocator</h1>
                <p class="text-slate-500 flex items-center gap-2">
                    <i data-lucide="shield-check" class="w-4 h-4 text-green-600"></i>
                    Generator & Billing System
                </p>
            </div>
        </div>

        <!-- Billing Header Inputs -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 flex items-center gap-2">
                <i data-lucide="building" class="w-4 h-4"></i> Invoice Header Details
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Your Company Name</label>
                    <input type="text" id="companyName" value="Plum Packers & Co." class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Goyal Dry Fruits">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Customer Name (To:)</label>
                    <div class="relative">
                        <i data-lucide="user" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
                        <input type="text" id="customerName" class="w-full border border-slate-300 rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Sharma Traders">
                    </div>
                </div>
            </div>
            
            <!-- New Fields: Tagline & Address -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-slate-100">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Tagline / Description (Under Title)</label>
                    <input type="text" id="taglineInput" value="(Wholesale & Retailer Dealers of: Dry Fruits and Gift Pack)" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Footer Address</label>
                    <input type="text" id="addressInput" value="Shop No. 5, Main Road, Sadarpur, Noida Sector 45, Noida - 201303 (Near by Hanuman Mandir)" class="w-full border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
            </div>
        </div>

        <!-- Controls & Data Entry -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
            <!-- Toolbar -->
            <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex flex-wrap gap-4 justify-between items-center">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Ideal Lot Range</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="targetSize" value="30" class="w-24 border border-slate-300 rounded-lg px-3 py-2 font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <span class="text-sm text-slate-400">boxes / lot</span>
                    </div>
                </div>
                <button onclick="resetCounts()" class="text-sm font-medium text-slate-500 hover:text-red-600 bg-white border border-slate-200 hover:bg-red-50 hover:border-red-200 px-3 py-1.5 rounded-lg flex items-center gap-2 transition">
                    <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset Counts
                </button>
            </div>

            <!-- Grade List -->
            <div class="p-6">
                <div class="hidden md:grid grid-cols-12 gap-4 mb-2 px-2">
                    <div class="col-span-5 text-xs font-bold text-slate-400 uppercase">Item Name</div>
                    <div class="col-span-3 text-xs font-bold text-slate-400 uppercase">Quantity (Boxes)</div>
                    <div class="col-span-3 text-xs font-bold text-slate-400 uppercase">Price (Rate)</div>
                    <div class="col-span-1"></div>
                </div>
                
                <div id="gradesContainer" class="space-y-3">
                    <!-- Rows injected by JS -->
                </div>

                <div class="mt-6">
                    <button onclick="addGrade()" class="flex items-center gap-2 text-indigo-700 hover:bg-indigo-50 px-4 py-2 rounded-lg font-medium transition border border-transparent hover:border-indigo-100">
                        <i data-lucide="plus" class="w-4 h-4"></i> Add Item
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Message -->
        <div id="statusArea"></div>

        <!-- Screen Results -->
        <div id="resultsArea" class="space-y-4 hidden">
            <div class="flex flex-wrap justify-between items-end pb-2 border-b border-slate-200 gap-2">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">Allocation Plan</h2>
                    <p class="text-sm text-slate-500">Verify lots before printing.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyResults()" id="copyBtn" class="flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-indigo-700 bg-white border border-slate-200 px-4 py-2 rounded-lg hover:shadow-sm transition">
                        <i data-lucide="copy" class="w-4 h-4"></i> <span>Copy Text</span>
                    </button>
                    <button onclick="window.print()" class="flex items-center gap-2 text-sm font-bold text-white bg-slate-800 hover:bg-slate-900 px-4 py-2 rounded-lg shadow-sm transition transform active:scale-95">
                        <i data-lucide="printer" class="w-4 h-4"></i> Print Bill / Save PDF
                    </button>
                </div>
            </div>
            
            <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Cards injected by JS -->
            </div>
        </div>
    </div>

    <!-- ================= PRINTABLE INVOICE (HIDDEN ON SCREEN) ================= -->
    <div class="print-only p-8 bg-white text-black font-serif">
        
        <!-- Header -->
        <div class="border-t-4 border-blue-800 mb-2"></div>
        <div class="text-center mb-6">
            <h2 class="text-xl font-bold italic underline mb-2">Invoice</h2>
            <h1 id="printCompany" class="text-4xl font-extrabold text-black mb-2 uppercase tracking-wide"></h1>
            <p id="printTagline" class="text-sm font-bold text-gray-700"></p>
        </div>

        <div class="border-b border-gray-400 mb-2"></div>

        <!-- Info Row -->
        <div class="flex justify-between items-end mb-4 px-2">
            <div class="w-1/2">
                <div class="flex items-end gap-2 border-b border-black pb-1">
                   <span class="font-bold text-lg">To:</span>
                   <span id="printCustomer" class="flex-1 text-lg font-medium pl-2"></span>
                </div>
            </div>
            <div class="text-right">
                <p id="printDate" class="font-medium text-gray-600"></p>
            </div>
        </div>

        <!-- Table -->
        <div class="w-full mb-8">
            <table id="printTable" class="w-full border-collapse border border-gray-400">
                <!-- Headers -->
                <thead id="printTableHead"></thead>
                <!-- Body -->
                <tbody id="printTableBody"></tbody>
                <!-- Footer -->
                <tfoot id="printTableFoot"></tfoot>
            </table>
        </div>

        <!-- Footer -->
        <div class="border-t-2 border-black mt-12 pt-2">
             <p id="printAddress" class="text-center text-xs text-gray-500"></p>
        </div>
    </div>

    <!-- ================= JAVASCRIPT LOGIC ================= -->
    <script>
        // --- STATE ---
        let state = {
            grades: [
                { id: 1, name: 'Large', count: 50, price: 0 },
                { id: 2, name: 'Medium', count: 90, price: 0 },
                { id: 3, name: 'Small', count: 100, price: 0 },
            ],
            results: [],
            targetSize: 30,
            status: null
        };

        // --- DOM ELEMENTS ---
        const els = {
            gradesContainer: document.getElementById('gradesContainer'),
            resultsArea: document.getElementById('resultsArea'),
            cardsContainer: document.getElementById('cardsContainer'),
            statusArea: document.getElementById('statusArea'),
            companyInput: document.getElementById('companyName'),
            customerInput: document.getElementById('customerName'),
            taglineInput: document.getElementById('taglineInput'),
            addressInput: document.getElementById('addressInput'),
            targetInput: document.getElementById('targetSize'),
            printCompany: document.getElementById('printCompany'),
            printTagline: document.getElementById('printTagline'),
            printCustomer: document.getElementById('printCustomer'),
            printAddress: document.getElementById('printAddress'),
            printDate: document.getElementById('printDate'),
            printTableHead: document.getElementById('printTableHead'),
            printTableBody: document.getElementById('printTableBody'),
            printTableFoot: document.getElementById('printTableFoot')
        };

        // --- INITIALIZATION ---
        els.printDate.textContent = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        
        // Event Listeners for Header/Footer Edits
        els.companyInput.addEventListener('input', updatePrintHeader);
        els.customerInput.addEventListener('input', updatePrintHeader);
        els.taglineInput.addEventListener('input', updatePrintHeader);
        els.addressInput.addEventListener('input', updatePrintHeader);

        els.targetInput.addEventListener('input', (e) => {
            state.targetSize = parseInt(e.target.value) || 30;
            calculate();
        });

        function updatePrintHeader() {
            els.printCompany.textContent = els.companyInput.value;
            els.printCustomer.textContent = els.customerInput.value;
            els.printTagline.textContent = els.taglineInput.value;
            els.printAddress.textContent = els.addressInput.value;
        }

        // --- LOGIC (SOLVER) ---
        function generateBaseParts(total, parts) {
            if (parts <= 0) return [total];
            const base = Math.floor(total / parts);
            const remainder = total % parts;
            const result = [];
            for (let i = 0; i < parts; i++) result.push(base + (i < remainder ? 1 : 0));
            return result;
        }

        function perturbDistribution(arr) {
            if (arr.length < 2) return arr;
            const newArr = [...arr];
            const i = Math.floor(Math.random() * newArr.length);
            let j = Math.floor(Math.random() * newArr.length);
            while (j === i) j = Math.floor(Math.random() * newArr.length);
            if (newArr[i] > 1) { newArr[i]--; newArr[j]++; }
            return newArr.sort((a, b) => a - b);
        }

        function isValid(lots, globalUsed) {
            const localSet = new Set(lots);
            if (localSet.size !== lots.length) return false;
            for (let n of lots) if (globalUsed.has(n)) return false;
            return true;
        }

        function solveForGrade(gradeCount, idealTarget, globalUsed) {
            const idealParts = Math.max(1, Math.round(gradeCount / idealTarget));
            let searchQueue = [idealParts];
            for (let offset = 1; offset < gradeCount; offset++) {
                if (idealParts + offset <= gradeCount) searchQueue.push(idealParts + offset);
                if (idealParts - offset >= 1) searchQueue.push(idealParts - offset);
                if (searchQueue.length > 50) break; 
            }

            for (let parts of searchQueue) {
                let currentLots = generateBaseParts(gradeCount, parts);
                for (let attempt = 0; attempt < 2000; attempt++) {
                    if (isValid(currentLots, globalUsed)) {
                        return { lots: currentLots, warning: parts !== idealParts };
                    }
                    currentLots = perturbDistribution(currentLots);
                }
            }
            throw new Error("No valid slot found");
        }

        function calculate() {
            const globalUsed = new Set();
            const finalAllocations = [];
            let hasFallbackWarning = false;
            let errorMsg = null;

            const hasData = state.grades.some(g => g.count > 0);
            if (!hasData) {
                state.results = [];
                renderResults();
                return;
            }

            for (let grade of state.grades) {
                if (!grade.count || grade.count <= 0) continue;
                try {
                    const solution = solveForGrade(grade.count, state.targetSize, globalUsed);
                    solution.lots.forEach(n => globalUsed.add(n));
                    if (solution.warning) hasFallbackWarning = true;
                    finalAllocations.push({
                        ...grade,
                        lots: solution.lots.sort((a, b) => a - b),
                        fallback: solution.warning
                    });
                } catch (e) {
                    errorMsg = `Could not fit grade: ${grade.name}`;
                    break; 
                }
            }

            if (errorMsg) {
                state.status = { type: 'error', msg: errorMsg };
                state.results = [];
            } else {
                state.results = finalAllocations;
                state.status = { 
                    type: hasFallbackWarning ? 'warning' : 'success', 
                    msg: hasFallbackWarning ? "Some lots adjusted to prevent clashes." : "Allocation successful."
                };
            }
            renderResults();
        }

        // --- RENDERING ---
        
        function renderGrades() {
            els.gradesContainer.innerHTML = state.grades.map((g, idx) => `
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center bg-slate-50 md:bg-transparent p-4 md:p-0 rounded-lg border md:border-0 border-slate-200">
                    <div class="col-span-1 md:col-span-5">
                        <label class="md:hidden block text-xs font-bold text-slate-500 mb-1">Item Name</label>
                        <input type="text" value="${g.name}" oninput="updateGrade(${g.id}, 'name', this.value)" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Item Name">
                    </div>
                    <div class="col-span-1 md:col-span-3">
                        <label class="md:hidden block text-xs font-bold text-slate-500 mb-1">Quantity</label>
                        <input type="number" value="${g.count}" oninput="updateGrade(${g.id}, 'count', this.value)" class="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 font-mono font-medium" placeholder="0">
                    </div>
                    <div class="col-span-1 md:col-span-3">
                        <label class="md:hidden block text-xs font-bold text-slate-500 mb-1">Price</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-400 font-serif">₹</span>
                            <input type="number" value="${g.price}" oninput="updateGrade(${g.id}, 'price', this.value)" class="w-full bg-white border border-slate-300 rounded-lg pl-7 pr-3 py-2 font-mono font-medium" placeholder="0.00">
                        </div>
                    </div>
                    <div class="col-span-1 flex justify-end md:justify-center">
                        <button onclick="removeGrade(${g.id})" class="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full transition">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderResults() {
            if (state.status?.type === 'error') {
                els.statusArea.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-lg flex items-start gap-3">
                        <i data-lucide="alert-triangle" class="text-red-600 mt-0.5"></i>
                        <p class="text-red-700 text-sm">${state.status.msg}</p>
                    </div>
                `;
            } else if (state.results.length > 0) {
                els.statusArea.innerHTML = ''; 
            } else {
                els.statusArea.innerHTML = '';
            }

            if (state.results.length > 0) {
                els.resultsArea.classList.remove('hidden');
                els.cardsContainer.innerHTML = state.results.map(res => `
                    <div class="bg-white rounded-xl shadow-sm border-l-4 p-5 ${res.fallback ? 'border-amber-400' : 'border-indigo-500'}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-slate-900">${res.name || 'Item'}</h3>
                                <div class="text-sm text-slate-500 mt-1">${res.count} boxes @ ₹${res.price || 0}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold text-indigo-600 leading-none">${res.lots.length}</div>
                                <div class="text-xs font-bold text-slate-400 uppercase mt-1">Lots</div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${res.lots.map(lot => `
                                <span class="bg-indigo-50 text-indigo-700 font-mono font-bold text-sm px-2 py-1 rounded border border-indigo-100">${lot}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                els.resultsArea.classList.add('hidden');
            }

            renderPrintTable();
            lucide.createIcons();
        }

        function renderPrintTable() {
            if (state.results.length === 0) return;

            // 1. Header
            els.printTableHead.innerHTML = `
                <tr class="bg-gray-200 text-black">
                    <th class="border border-gray-400 px-2 py-2 w-12 text-center font-bold text-sm">S.No.</th>
                    <th class="border border-gray-400 px-4 py-2 text-left font-bold text-sm">Item</th>
                    <th class="border border-gray-400 px-2 py-2 text-center font-bold text-sm w-24">Lot No.</th>
                    <th class="border border-gray-400 px-2 py-2 text-center font-bold text-sm w-24">Quantity</th>
                    <th class="border border-gray-400 px-2 py-2 text-right font-bold text-sm w-24">Price</th>
                    <th class="border border-gray-400 px-2 py-2 text-right font-bold text-sm w-32">Amount</th>
                </tr>
            `;

            // 2. Rows (Split by lot)
            let totalAmount = 0;
            let totalBoxes = 0;
            let sno = 1;
            let rowsHTML = '';

            state.results.forEach((res) => {
                // Sort lots to look tidy
                const sortedLots = [...res.lots].sort((a, b) => a - b);
                
                sortedLots.forEach((lotVal) => {
                    const priceVal = parseFloat(res.price || 0);
                    const amount = lotVal * priceVal;
                    
                    totalAmount += amount;
                    totalBoxes += lotVal;

                    // Only show price/amount text if price is greater than 0
                    const priceDisplay = priceVal > 0 ? priceVal.toFixed(2) : '';
                    const amountDisplay = priceVal > 0 ? amount.toLocaleString('en-IN', { minimumFractionDigits: 2 }) : '';

                    rowsHTML += `
                        <tr class="h-10 border-b border-gray-300">
                            <td class="border border-gray-400 px-2 py-2 text-center align-middle">${sno++}</td>
                            <td class="border border-gray-400 px-4 py-2 text-left align-middle font-medium">${res.name}</td>
                            <td class="border border-gray-400 px-2 py-2 text-center align-middle font-mono">${lotVal}</td>
                            <td class="border border-gray-400 px-2 py-2 text-center align-middle">${lotVal}</td>
                            <td class="border border-gray-400 px-2 py-2 text-right align-middle">${priceDisplay}</td>
                            <td class="border border-gray-400 px-2 py-2 text-right align-middle font-bold">${amountDisplay}</td>
                        </tr>
                    `;
                });
            });

            // Fill empty rows if less than 5 lines
            const emptyCount = Math.max(0, 8 - sno); 
            let emptyRows = '';
            for(let k=0; k<emptyCount; k++){
                emptyRows += `
                    <tr class="h-10 border-b border-gray-300">
                        <td class="border border-gray-400"></td>
                        <td class="border border-gray-400"></td>
                        <td class="border border-gray-400"></td>
                        <td class="border border-gray-400"></td>
                        <td class="border border-gray-400"></td>
                        <td class="border border-gray-400"></td>
                    </tr>
                `;
            }

            els.printTableBody.innerHTML = rowsHTML + emptyRows;

            // 3. Footer
            const totalAmountDisplay = totalAmount > 0 ? totalAmount.toLocaleString('en-IN', { style: 'currency', currency: 'INR' }) : '';

            els.printTableFoot.innerHTML = `
                <tr class="bg-gray-100 font-bold border-t-2 border-gray-400">
                    <td colSpan="3" class="border border-gray-400 px-4 py-2 text-right uppercase text-sm">Total</td>
                    <td class="border border-gray-400 px-2 py-2 text-center text-lg">${totalBoxes}</td>
                    <td class="border border-gray-400 px-2 py-2"></td>
                    <td class="border border-gray-400 px-2 py-2 text-right text-lg">${totalAmountDisplay}</td>
                </tr>
            `;
        }

        // --- ACTIONS ---

        function addGrade() {
            const newId = Math.max(0, ...state.grades.map(g => g.id)) + 1;
            state.grades.push({ id: newId, name: '', count: '', price: '' });
            renderGrades();
        }

        function removeGrade(id) {
            state.grades = state.grades.filter(g => g.id !== id);
            renderGrades();
            calculate();
        }

        function updateGrade(id, field, value) {
            const grade = state.grades.find(g => g.id === id);
            if (grade) {
                if (field === 'count') grade[field] = parseInt(value) || '';
                else if (field === 'price') grade[field] = parseFloat(value) || '';
                else grade[field] = value;
                calculate(); 
            }
        }

        function resetCounts() {
            state.grades.forEach(g => g.count = '');
            state.results = [];
            state.status = null;
            renderGrades();
            renderResults();
        }

        function copyResults() {
            if (!state.results.length) return;
            let text = `Packing Plan\n\n`;
            state.results.forEach(r => {
                text += `${r.name} (${r.count}): ${r.lots.join(', ')}\n`;
            });
            
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const btn = document.getElementById('copyBtn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-600"></i> Copied!`;
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    lucide.createIcons();
                }, 2000);
            } catch (err) {}
            document.body.removeChild(textArea);
        }

        // Init
        updatePrintHeader();
        renderGrades();
        calculate();

    </script>
</body>
</html>
